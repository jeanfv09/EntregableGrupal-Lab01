@model Lab01_Grupo1.Models.CitaPagoViewModel
@{
ย ย ViewData["Title"] = "Procesar Pago";
}

<!-- Modal de รฉxito -->
<div id="successModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
ย ย <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:10px; text-align:center; min-width:300px;">
ย ย ย ย <h3 style="color:green; margin-bottom:15px;">โ Compra Exitosa</h3>
ย ย ย ย <p>El pago de $@Model.Precio se procesรณ correctamente</p>
ย ย ย ย <p><strong>Mรฉdico:</strong> @Model.MedicoNombre</p>
ย ย ย ย <p><strong>Fecha:</strong> @Model.FechaHora.ToString("dd/MM/yyyy HH:mm")</p>
ย ย ย ย <button onclick="redirigirAIndex()" style="background:#28a745; color:white; border:none; padding:8px 20px; border-radius:5px; margin-top:15px; cursor:pointer;">
ย ย ย ย ย ย Aceptar
ย ย ย ย </button>
ย ย </div>
</div>

<div class="row">
ย ย <div class="col-md-6">
ย ย ย ย <h3>Resumen de tu Cita</h3>
ย ย ย ย <div class="card">
ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย <p><strong>Mรฉdico:</strong> @Model.MedicoNombre</p>
ย ย ย ย ย ย ย ย <p><strong>Especialidad:</strong> @Model.Especialidad</p>
ย ย ย ย ย ย ย ย <p><strong>Fecha:</strong> @Model.FechaHora.ToString("dd/MM/yyyy HH:mm")</p>
ย ย ย ย ย ย ย ย <p><strong>Motivo:</strong> @Model.MotivoConsulta</p>
ย ย ย ย ย ย ย ย <hr>
ย ย ย ย ย ย ย ย <h4>Total a pagar: $@Model.Precio</h4>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div class="col-md-6">
ย ย ย ย <h3>Informaciรณn de Pago</h3>
ย ย ย ย 
ย ย ย ย <form id="payment-form" method="post" asp-action="ProcesarPago">
ย ย ย ย ย ย <input type="hidden" asp-for="MedicoId" />
ย ย ย ย ย ย <input type="hidden" asp-for="MedicoNombre" />
ย ย ย ย ย ย <input type="hidden" asp-for="Especialidad" />
ย ย ย ย ย ย <input type="hidden" asp-for="MotivoConsulta" />
ย ย ย ย ย ย <input type="hidden" asp-for="FechaHora" />
ย ย ย ย ย ย <input type="hidden" asp-for="Precio" />
ย ย ย ย ย ย 
ย ย ย ย ย ย <!-- Braintree Drop-in UI -->
ย ย ย ย ย ย <div id="bt-dropin"></div>
ย ย ย ย ย ย <input type="hidden" id="nonce" name="paymentMethodNonce" />
ย ย ย ย ย ย 
ย ย ย ย ย ย <button type="submit" class="btn btn-success btn-lg w-100 mt-3" id="submit-button">
ย ย ย ย ย ย ย ย ๐ณ Pagar y Confirmar Cita
ย ย ย ย ย ย </button>
ย ย ย ย </form>

ย ย ย ย <div class="text-center mt-3">
ย ย ย ย ย ย <small class="text-muted">Pago seguro mediante Braintree</small>
ย ย ย ย </div>
ย ย </div>
</div>

@section Scripts {
ย ย <script src="https://js.braintreegateway.com/web/dropin/1.44.0/js/dropin.min.js"></script>
ย ย <script>
ย ย ย ย function redirigirAIndex() {
ย ย ย ย ย ย // Redirigir a la pรกgina Index de Usuarios
ย ย ย ย ย ย window.location.href = '/Usuarios/Index';
ย ย ย ย }

ย ย ย ย var form = document.querySelector('#payment-form');
ย ย ย ย var client_token = '@ViewBag.ClientToken';
        
        // Convertimos el precio del modelo a una variable JS para usarlo en PayPal
        var paymentAmount = '@Model.Precio';

ย ย ย ย braintree.dropin.create({
ย ย ย ย ย ย authorization: client_token,
ย ย ย ย ย ย container: '#bt-dropin',
ย ย ย ย ย ย card: {
ย ย ย ย ย ย ย ย cardholderName: {
ย ย ย ย ย ย ย ย ย ย required: true
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย overrides: {
ย ย ย ย ย ย ย ย ย ย fields: {
ย ย ย ย ย ย ย ย ย ย ย ย number: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย placeholder: 'Nรบmero de tarjeta',
ย ย ย ย ย ย ย ย ย ย ย ย ย ย show: true
ย ย ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย ย ย cvv: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย required: true,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย show: true,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย placeholder: 'CVV'
ย ย ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย ย ย expirationDate: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย placeholder: 'MM/AA',
ย ย ย ย ย ย ย ย ย ย ย ย ย ย show: true
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย },
ย ย ย ย ย ย // ๐จ CORRECCIรN CLAVE: Cambiamos 'flow' a 'checkout' para forzar el botรณn de pago
ย ย ย ย ย ย // y le pasamos el monto para la transacciรณn.
ย ย ย ย ย ย paypal: {
ย ย ย ย ย ย ย ย flow: 'checkout',
                amount: paymentAmount,
                currency: 'USD' // Asume USD, ajusta si usas otra moneda
ย ย ย ย ย ย }
ย ย ย ย }, function (createErr, instance) {
ย ย ย ย ย ย if (createErr) {
ย ย ย ย ย ย ย ย console.error('Error creating Drop-in:', createErr);
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย form.addEventListener('submit', function (event) {
ย ย ย ย ย ย ย ย event.preventDefault();

ย ย ย ย ย ย ย ย document.getElementById('submit-button').disabled = true;
ย ย ย ย ย ย ย ย document.getElementById('submit-button').textContent = 'Procesando pago...';

ย ย ย ย ย ย ย ย instance.requestPaymentMethod(function (err, payload) {
ย ย ย ย ย ย ย ย ย ย if (err) {
ย ย ย ย ย ย ย ย ย ย ย ย console.log('Error', err);
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('submit-button').disabled = false;
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('submit-button').textContent = 'Pagar y Confirmar Cita';
ย ย ย ย ย ย ย ย ย ย ย ย // ๐จ CORRECCIรN: Usar modal personalizado en lugar de alert()
                        // Para evitar problemas en el iframe
                        mostrarError('Error en el pago: ' + err.message);
ย ย ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย // Agregar el nonce al formulario
ย ย ย ย ย ย ย ย ย ย document.getElementById('nonce').value = payload.nonce;
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย // Enviar el pago por AJAX
ย ย ย ย ย ย ย ย ย ย fetch(form.action, {
ย ย ย ย ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย ย ย ย ย body: new FormData(form)
ย ย ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย ย ย .then(response => {
ย ย ย ย ย ย ย ย ย ย ย ย // Mostrar el modal de รฉxito
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('successModal').style.display = 'block';
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('submit-button').style.display = 'none';
ย ย ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย ย ย .catch(error => {
ย ย ย ย ย ย ย ย ย ย ย ย console.error('Error:', error);
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('submit-button').disabled = false;
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('submit-button').textContent = 'Pagar y Confirmar Cita';
ย ย ย ย ย ย ย ย ย ย ย ย // ๐จ CORRECCIรN: Usar modal personalizado en lugar de alert()
                        mostrarError('Error de conexiรณn: ' + error.message);
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย });
ย ย ย ย });
ย ย </script>
    <script>
        // Funciรณn de error personalizada (Reemplaza alert())
        function mostrarError(mensaje) {
            // Creamos un modal de error simple si no existe
            let errorModal = document.getElementById('errorModal');
            if (!errorModal) {
                errorModal = document.createElement('div');
                errorModal.id = 'errorModal';
                errorModal.innerHTML = `
                    <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;">
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:10px; text-align:center; min-width:300px;">
                            <h3 style="color:red; margin-bottom:15px;">โ Error de Pago</h3>
                            <p id="errorMessageContent"></p>
                            <button onclick="document.getElementById('errorModal').style.display = 'none';" 
                                    style="background:#dc3545; color:white; border:none; padding:8px 20px; border-radius:5px; margin-top:15px; cursor:pointer;">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
            }
            document.getElementById('errorMessageContent').textContent = mensaje;
            errorModal.style.display = 'block';
        }
    </script>
}