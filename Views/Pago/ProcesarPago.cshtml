@model Lab01_Grupo1.Models.CitaPagoViewModel
@{
    ViewData["Title"] = "Procesar Pago";
}
<!-- Modal de Ã©xito -->
<div id="successModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
Â  Â  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:10px; text-align:center; min-width:300px;">
Â  Â  Â  Â  <h3 style="color:green; margin-bottom:15px;">âœ… Compra Exitosa</h3>
Â  Â  Â  Â  <p>El pago de $@Model.Precio se procesÃ³ correctamente</p>
Â  Â  Â  Â  <p><strong>MÃ©dico:</strong> @Model.MedicoNombre</p>
Â  Â  Â  Â  <p><strong>Fecha:</strong> @Model.FechaHora.ToString("dd/MM/yyyy HH:mm")</p>
Â  Â  Â  Â  <button onclick="redirigirAIndex()" style="background:#28a745; color:white; border:none; padding:8px 20px; border-radius:5px; margin-top:15px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Aceptar
Â  Â  Â  Â  </button>
Â  Â  </div>
</div>

<div class="row">
    <div class="col-md-6">
        <h3>Resumen de tu Cita</h3>
        <div class="card">
            <div class="card-body">
                <p><strong>MÃ©dico:</strong> @Model.MedicoNombre</p>
                <p><strong>Especialidad:</strong> @Model.Especialidad</p>
                <p><strong>Fecha:</strong> @Model.FechaHora.ToString("dd/MM/yyyy HH:mm")</p>
                <p><strong>Motivo:</strong> @Model.MotivoConsulta</p>
                <hr>
                <h4>Total a pagar: $@Model.Precio</h4>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <h3>InformaciÃ³n de Pago</h3>
        
        <form id="payment-form" method="post" asp-action="ProcesarPago">
            <input type="hidden" asp-for="MedicoId" />
            <input type="hidden" asp-for="MedicoNombre" />
            <input type="hidden" asp-for="Especialidad" />
            <input type="hidden" asp-for="MotivoConsulta" />
            <input type="hidden" asp-for="FechaHora" />
            <input type="hidden" asp-for="Precio" />
            
            <!-- Braintree Drop-in UI -->
            <div id="bt-dropin"></div>
            <input type="hidden" id="nonce" name="paymentMethodNonce" />
            
            <button type="submit" class="btn btn-success btn-lg w-100 mt-3" id="submit-button">
                ğŸ’³ Pagar $@Model.Precio y Confirmar Cita

            </button>
        </form>

        <div class="text-center mt-3">
            <small class="text-muted">Pago seguro mediante Braintree</small>
        </div>
    </div>
</div>

@section Scripts {
     <script src="https://js.braintreegateway.com/web/dropin/1.44.0/js/dropin.min.js">
</script>
    <script>
Â  Â  Â  Â  function redirigirAIndex() {
Â  Â  Â  Â  Â  Â  // Redirigir a la pÃ¡gina Index de Usuarios
Â  Â  Â  Â  Â  Â  window.location.href = '/Usuarios/Index';
Â  Â  Â  Â  }

        var form = document.querySelector('#payment-form');
        var client_token = '@ViewBag.ClientToken';

        // Convertimos el precio del modelo a una variable JS para usarlo en PayPal
        var paymentAmount = '@Model.Precio';

        braintree.dropin.create({
Â  Â  Â  Â  Â  Â  authorization: client_token,
Â  Â  Â  Â  Â  Â  container: '#bt-dropin',
Â  Â  Â  Â  Â  Â  card: {
Â  Â  Â  Â  Â  Â  Â  Â  cardholderName: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  required: true
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  overrides: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fields: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  number: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder: 'NÃºmero de tarjeta',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  show: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cvv: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  required: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  show: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder: 'CVV'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expirationDate: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder: 'MM/AA',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  show: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  // ğŸš¨ CORRECCIÃ“N CLAVE: Cambiamos 'flow' a 'checkout' para forzar el botÃ³n de pago
Â  Â  Â  Â  Â  Â  // y le pasamos el monto para la transacciÃ³n.
Â  Â  Â  Â  Â  Â  paypal: {
Â  Â  Â  Â  Â  Â  Â  Â  flow: 'checkout',
                amount: paymentAmount,
                currency: 'USD' // Asume USD, ajusta si usas otra moneda
Â  Â  Â  Â  Â  Â  }
        }, function (createErr, instance) {
            if (createErr) {
                console.log('Error', createErr);
                return;
            }        

            form.addEventListener('submit', function (event) {
                event.preventDefault();

                document.getElementById('submit-button').disabled = true;
                document.getElementById('submit-button').textContent = 'Procesando pago...';

                instance.requestPaymentMethod(function (err, payload) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('Error', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submit-button').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submit-button').textContent = 'Pagar y Confirmar Cita';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ğŸš¨ CORRECCIÃ“N: Usar modal personalizado en lugar de alert()
                        // Para evitar problemas en el iframe
                        mostrarError('Error en el pago: ' + err.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

                    // Agregar el nonce al formulario
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nonce').value = payload.nonce;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enviar el pago por AJAX
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetch(form.action, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: new FormData(form)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mostrar el modal de Ã©xito
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('successModal').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submit-button').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submit-button').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submit-button').textContent = 'Pagar y Confirmar Cita';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ğŸš¨ CORRECCIÃ“N: Usar modal personalizado en lugar de alert()
                        mostrarError('Error de conexiÃ³n: ' + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  </script>
    <script>
        // FunciÃ³n de error personalizada (Reemplaza alert())
        function mostrarError(mensaje) {
            // Creamos un modal de error simple si no existe
            let errorModal = document.getElementById('errorModal');
            if (!errorModal) {
                errorModal = document.createElement('div');
                errorModal.id = 'errorModal';
                errorModal.innerHTML = `
                    <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;">
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:10px; text-align:center; min-width:300px;">
                            <h3 style="color:red; margin-bottom:15px;">âŒ Error de Pago</h3>
                            <p id="errorMessageContent"></p>
                            <button onclick="document.getElementById('errorModal').style.display = 'none';" 
                                    style="background:#dc3545; color:white; border:none; padding:8px 20px; border-radius:5px; margin-top:15px; cursor:pointer;">
                                Cerrar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
            }
            document.getElementById('errorMessageContent').textContent = mensaje;
            errorModal.style.display = 'block';
        }
    </script>
}